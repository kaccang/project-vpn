#!/bin/bash

set -euo pipefail

LIB_DIR=$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")/lib" && pwd)
source "${LIB_DIR}/common.sh"

profiles_json=$(run_helper list)
readarray -t profiles < <(printf '%s\n' "$profiles_json" | python3 -c 'import json,sys; data=json.load(sys.stdin); [print(json.dumps(item)) for item in data]')

if [[ ${#profiles[@]} -eq 0 ]]; then
    echo "Belum ada profile."
    read -n 1 -s -r -p "Tekan tombol untuk kembali ke menu"
    echo ""
    "${LIB_DIR}/../menu-profile"
    exit 0
fi

echo "============================================"
echo " Daftar Profile"
echo "============================================"
idx=1
for item in "${profiles[@]}"; do
    IDX=$idx python3 - <<'PY' <<<"$item"
import json, os, sys
data = json.loads(sys.stdin.read())
idx = int(os.environ["IDX"])
print("{no:>2}) {name:<15} {domain:<20} CPU:{cpu:<4}% RAM:{ram:<6}MB BW:{bw:.2f}TB Exp:{exp} Status:{status}".format(
    no=idx,
    name=data.get("name",""),
    domain=data.get("domain",""),
    cpu=data.get("cpu_percent",0),
    ram=data.get("ram_mb",0),
    bw=data.get("remaining_bandwidth_tb",0.0),
    exp=data.get("expires_at",""),
    status=data.get("status","unknown")
))
PY
    idx=$((idx + 1))
done

selection=""
while true; do
    read -rp "Pilih nomor yang akan dihapus: " selection || exit 1
    if [[ "$selection" =~ ^[0-9]+$ ]] && (( selection >= 1 && selection <= ${#profiles[@]} )); then
        break
    fi
    echo "Nomor tidak valid."
done

profile_json="${profiles[$((selection - 1))]}"
name=$(printf '%s\n' "$profile_json" | python3 -c 'import json,sys; data=json.load(sys.stdin); print(data.get("name",""))')
container=$(printf '%s\n' "$profile_json" | python3 -c 'import json,sys; data=json.load(sys.stdin); print(data.get("container_name") or "")')

echo "--------------------------------------------"
python3 - <<'PY' <<<"$profile_json"
import json,sys
data=json.load(sys.stdin)
print(json.dumps(data, indent=2))
PY
echo "--------------------------------------------"

read -rp "Konfirmasi hapus profile '$name'? (y/N): " confirm
if [[ "${confirm,,}" != "y" ]]; then
    echo "Dibatalkan."
    "${LIB_DIR}/../menu-profile"
    exit 0
fi

if command -v docker >/dev/null 2>&1 && [[ -n "$container" ]]; then
    if docker ps -a --format '{{.Names}}' | grep -qx "$container"; then
        docker rm -f "$container" >/dev/null 2>&1 || echo "Gagal menghapus container $container"
    fi
fi

run_helper delete --name "$name"
echo "Profile '$name' dihapus."

read -n 1 -s -r -p "Tekan tombol untuk kembali ke menu"
echo ""
"${LIB_DIR}/../menu-profile"
