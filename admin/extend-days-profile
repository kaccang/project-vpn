#!/bin/bash

set -euo pipefail

LIB_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/lib" && pwd)
source "${LIB_DIR}/common.sh"

profiles_json=$(run_helper list)
readarray -t profiles < <(printf '%s\n' "$profiles_json" | python3 -c 'import json,sys; data=json.load(sys.stdin); [print(json.dumps(item)) for item in data]')

if [[ ${#profiles[@]} -eq 0 ]]; then
    echo "Belum ada profile."
    read -n 1 -s -r -p "Tekan tombol untuk kembali ke menu"
    echo ""
    "${LIB_DIR}/../menu-profile"
    exit 0
fi

echo "============================================"
echo " Profile - Perpanjang Hari"
echo "============================================"
idx=1
for item in "${profiles[@]}"; do
    IDX=$idx python3 - <<'PY' <<<"$item"
import json, os, sys
data=json.loads(sys.stdin.read())
idx=int(os.environ["IDX"])
print("{no:>2}) {name:<15} Exp:{exp:<10} (sisa {days} hari)".format(
    no=idx,
    name=data.get("name",""),
    exp=data.get("expires_at",""),
    days=data.get("remaining_days","0")
))
PY
    idx=$((idx + 1))
done

selection=""
while true; do
    read -rp "Pilih nomor profile: " selection || exit 1
    if [[ "$selection" =~ ^[0-9]+$ ]] && (( selection >= 1 && selection <= ${#profiles[@]} )); then
        break
    fi
    echo "Nomor tidak valid."
done

profile_json="${profiles[$((selection - 1))]}"
name=$(printf '%s\n' "$profile_json" | python3 -c 'import json,sys; data=json.load(sys.stdin); print(data.get("name",""))')

extend_days=""
while true; do
    read -rp "Tambah berapa hari: " extend_days || exit 1
    if [[ "$extend_days" =~ ^[0-9]+$ && "$extend_days" -gt 0 ]]; then
        break
    fi
    echo "Masukkan angka hari > 0."
done

result=$(run_helper extend_days --name "$name" --days "$extend_days")

echo "--------------------------------------------"
echo "Expired baru:"
echo "$result" | python3 -m json.tool
echo "--------------------------------------------"

container=$(printf '%s\n' "$profile_json" | python3 -c 'import json,sys; data=json.load(sys.stdin); print(data.get("container_name") or "")')
if [[ -n "$container" ]]; then
    echo "Reminder: jalankan sinkronisasi expired dalam container '$container'."
fi

read -n 1 -s -r -p "Tekan tombol untuk kembali ke menu"
echo ""
"${LIB_DIR}/../menu-profile"